<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>暮暮的账本</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFF9F5">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); background-color: #FFF9F5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .icon { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }
    </style>
</head>
<body class="text-[#5D5D5D] font-sans antialiased select-none h-screen flex flex-col">

    <div id="app" class="flex-1 overflow-y-auto hide-scrollbar max-w-md mx-auto w-full bg-[#FFF9F5] shadow-2xl relative"></div>
    <div id="modal-container"></div>

    <script>
        const ICONS = {
            menu: '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>',
            plus: '<svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            x: '<svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
            trash: '<svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
            chevronLeft: '<svg class="icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>',
            chevronRight: '<svg class="icon" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>',
            message: '<svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
            download: '<svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
            save: '<svg class="icon" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>',
            cat: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 5c.67 0 1.35.09 2 .26 1.78-2 5.03-2.84 6.42-2.26 1.4.58-.42 7-.42 7 .57 1.07 1 2.24 1 3.44C21 17.9 16.97 21 12 21s-9-3.1-9-7.56c0-1.25.5-2.5 1-3.5 0 0-1.82-6.42-.42-7 1.39-.58 4.64.26 6.42 2.26 .65-.17 1.33-.26 2-.26z"></path></svg>',
            ghost: '<svg class="icon" viewBox="0 0 24 24"><path d="M9 22l3-3 3 3 3-3 3 3V10a9 9 0 0 0-18 0v12l3-3z"></path><path d="M8 10h.01"></path><path d="M12 10h.01"></path><path d="M16 10h.01"></path></svg>',
            palette: '<svg class="icon" viewBox="0 0 24 24"><circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle><circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></svg>',
            coffee: '<svg class="icon" viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>',
            shield: '<svg class="icon" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>',
            home: '<svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',
            bag: '<svg class="icon" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>',
            heart: '<svg class="icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>'
        };

        const CATEGORIES = {
            expense: [
                { id: 'cats', name: '圣代&橘子', keywords: ['宠物', '猫', '罐头', '猫砂', '疫苗', '医院'], icon: 'cat', color: 'bg-[#FFDAB9] text-[#8B4513]' },
                { id: 'toys', name: '谷子/周边', keywords: ['娱乐', '谷子', '吧唧', '手办', '毛绒', '游戏', '任天堂', '宝可梦'], icon: 'ghost', color: 'bg-[#E6E6FA] text-[#6A5ACD]' },
                { id: 'art', name: '画材/工作', keywords: ['工作', '画材', '设备', '笔', '纸', '约稿', '软件'], icon: 'palette', color: 'bg-[#E0FFFF] text-[#008B8B]' },
                { id: 'food', name: '餐饮/饮食', keywords: ['饮食', '餐饮', '吃饭', '外卖', '零食', '奶茶'], icon: 'coffee', color: 'bg-[#FFFACD] text-[#DAA520]' },
                { id: 'insurance', name: '社保/医保', keywords: ['社保', '医保', '保险'], icon: 'shield', color: 'bg-[#D1E8FF] text-[#2B6CB0]' },
                { id: 'living', name: '居住/日用', keywords: ['日用', '居住', '水电', '房租', '话费', '健康'], icon: 'home', color: 'bg-[#F0FFF0] text-[#2E8B57]' },
                { id: 'shopping', name: '服饰/购物', keywords: ['服饰', '购物', '衣服', '鞋', '化妆', '淘宝'], icon: 'bag', color: 'bg-[#FFB6C1] text-[#C71585]' },
                { id: 'other', name: '其他', keywords: ['其他', '杂项'], icon: 'heart', color: 'bg-[#F5F5F5] text-[#696969]' },
            ],
            income: [
                { id: 'salary', name: '稿费/工资', keywords: ['工资', '稿费', '项目', '尾款'], icon: 'palette', color: 'bg-[#E0FFFF] text-[#008B8B]' },
                { id: 'xianyu', name: '闲鱼回血', keywords: ['闲鱼', '出物'], icon: 'bag', color: 'bg-[#FFEFD5] text-[#FF8C00]' },
                { id: 'other', name: '其他收入', keywords: ['利息', '红包'], icon: 'heart', color: 'bg-[#F5F5F5] text-[#696969]' },
            ]
        };

        const state = {
            transactions: [],
            budget: 5000,
            currentDate: new Date(),
            modalOpen: false,
            settingsOpen: false,
            formType: 'expense',
            formAmount: '',
            formCategory: '',
            formNote: '',
            formDate: new Date().toISOString().split('T')[0]
        };

        function init() {
            try {
                // 读取历史数据
                const keys = ['mumu_companion_data', 'mumu_otaku_data_v2', 'mumu_wallet_data'];
                let data = null;
                for(let k of keys) {
                    const saved = localStorage.getItem(k);
                    if(saved) { data = JSON.parse(saved); break; }
                }
                if(data) state.transactions = data;

                const savedBudget = localStorage.getItem('mumu_budget_limit');
                if(savedBudget) state.budget = Number(savedBudget);
            } catch(e) {}
            render();
        }

        function save() {
            localStorage.setItem('mumu_companion_data', JSON.stringify(state.transactions));
            localStorage.setItem('mumu_budget_limit', state.budget);
        }

        // --- 核心解析逻辑 ---
        function parseChineseDate(str) {
            if(!str) return null;
            const s = str.trim();
            // 匹配 2024年11月22日
            const m1 = s.match(/(\d{4})年(\d{1,2})月(\d{1,2})?日?/);
            if(m1) return new Date(m1[1], m1[2]-1, m1[3]||1).toISOString();
            // 匹配 2024-11-22 或 2024/11/22
            if(s.match(/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/)) return new Date(s).toISOString();
            return null;
        }

        // --- 智能去重逻辑 ---
        function isDuplicate(newTx) {
            return state.transactions.some(oldTx => {
                // 比较四个关键维度：日期(天)、金额、类型、备注
                const d1 = new Date(oldTx.date).toDateString();
                const d2 = new Date(newTx.date).toDateString();
                return d1 === d2 && 
                       oldTx.amount === newTx.amount && 
                       oldTx.type === newTx.type && 
                       (oldTx.note || '').trim() === (newTx.note || '').trim();
            });
        }

        function render() {
            const app = document.getElementById('app');
            const y = state.currentDate.getFullYear();
            const m = state.currentDate.getMonth();
            
            const monthTx = state.transactions.filter(t => {
                const d = new Date(t.date);
                return d.getFullYear() === y && d.getMonth() === m;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            let income = 0, expense = 0;
            monthTx.forEach(t => t.type === 'income' ? income+=Number(t.amount) : expense+=Number(t.amount));
            const remaining = state.budget - expense;
            const remainingPercent = state.budget > 0 ? (remaining/state.budget)*100 : 0;

            // AI 文案逻辑
            let aiMsg = "我是你的管家。每一笔支出，我都看在眼里哦。";
            const isCurrent = m === new Date().getMonth() && y === new Date().getFullYear();
            
            if(!isCurrent) aiMsg = `正在查看 ${y}年${m+1}月 的账单...`;
            else if(remainingPercent <= 0) aiMsg = "（扶额）...透支了。快去画画回血，现在！马上！";
            else if(remainingPercent < 15) aiMsg = "警报拉响！再买我就要替橘子没收你的钱包了。";
            else if(remainingPercent < 40) aiMsg = "进度条过半了，接下来的日子，少喝两杯奶茶吧。";
            else if(remainingPercent > 90) aiMsg = "月初是存钱的黄金期，别一看到余额多就想买谷子。";
            else if(income > expense*2 && expense > 0) aiMsg = "这月收入不错嘛！画稿辛苦啦，奖励自己一个罐头？";
            else if(remainingPercent > 60) aiMsg = "状态平稳。记得给圣代和橘子留点体检费。";

            app.innerHTML = `
                <!-- 顶部固定区域 -->
                <div class="pt-4 px-6 pb-4 sticky top-0 bg-[#FFF9F5]/95 backdrop-blur-md z-10 border-b border-[#F5E6D3]/50">
                    <!-- AI Bubble -->
                    <div class="flex items-start gap-3 mb-4 fade-in">
                        <div class="w-10 h-10 rounded-full bg-[#4A4A4A] flex items-center justify-center text-white shrink-0 shadow-lg mt-1">
                            ${ICONS.message}
                        </div>
                        <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-[#E6E6FA] text-xs text-[#5D5D5D] leading-relaxed relative flex-1">
                            ${aiMsg}
                            <div class="absolute -left-1.5 top-4 w-2 h-2 bg-white border-l border-b border-[#E6E6FA] rotate-45"></div>
                        </div>
                    </div>

                    <!-- 控制栏 -->
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full shadow-sm border border-[#F5F5F5]">
                            <button onclick="changeMonth(-1)" class="text-[#BCBCBC] active:text-[#4A4A4A]">${ICONS.chevronLeft}</button>
                            <span class="text-sm font-bold text-[#4A4A4A] tabular-nums">${y}.${m+1}</span>
                            <button onclick="changeMonth(1)" class="text-[#BCBCBC] active:text-[#4A4A4A]">${ICONS.chevronRight}</button>
                        </div>
                        <div class="flex gap-2 text-[#8B8B8B]">
                            <button onclick="triggerBackup()" class="p-2 bg-white rounded-full shadow-sm active:scale-95 transition-transform" title="备份">${ICONS.save}</button>
                            <button onclick="triggerRestore()" class="p-2 bg-white rounded-full shadow-sm active:scale-95 transition-transform" title="恢复">${ICONS.download}</button>
                            <button onclick="openSettings()" class="p-2 bg-white rounded-full shadow-sm active:scale-95 transition-transform" title="设置">${ICONS.menu}</button>
                        </div>
                    </div>

                    <!-- 余额卡片 -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-[#4A4A4A] rounded-2xl p-4 text-white shadow-lg shadow-[#4A4A4A]/20 h-24 flex flex-col justify-between relative overflow-hidden">
                            <div class="absolute right-0 top-0 opacity-10 p-2 text-white">${ICONS.ghost}</div>
                            <p class="text-[#A0A0A0] text-[10px] uppercase">Remaining</p>
                            <div>
                                <p class="text-2xl font-bold tracking-tight">¥${remaining.toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-4 border border-[#E6E6FA] shadow-sm h-24 flex flex-col justify-between">
                            <p class="text-[#BCBCBC] text-[10px] uppercase">Income</p>
                            <div>
                                <p class="text-xl font-bold text-[#008B8B] tracking-tight">+¥${income.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 列表区域 -->
                <div class="px-6 pb-24 pt-2 space-y-2">
                    ${monthTx.length === 0 ? 
                        `<div class="text-center py-10 opacity-60">
                            <div class="w-8 h-8 mx-auto text-[#E6E6FA] mb-2">${ICONS.cat}</div>
                            <p class="text-[#B0A096] text-xs">这里空空如也...</p>
                        </div>` :
                        monthTx.map(t => {
                            const catList = t.type==='income' ? CATEGORIES.income : CATEGORIES.expense;
                            const cat = catList.find(c=>c.id===t.category) || CATEGORIES.expense[7];
                            return `
                            <div class="bg-white p-3 rounded-xl flex items-center justify-between border border-transparent active:scale-[0.99] transition-transform">
                                <div class="flex items-center gap-3">
                                    <div class="w-9 h-9 rounded-lg flex items-center justify-center shrink-0 ${cat.color}">
                                        ${ICONS[cat.icon] || ICONS.heart}
                                    </div>
                                    <div class="overflow-hidden">
                                        <p class="text-[#5D5D5D] font-bold text-xs truncate w-32">${cat.name}</p>
                                        <p class="text-[#B0B0B0] text-[10px] mt-0.5 truncate">${new Date(t.date).getDate()}日 ${t.note ? '· '+t.note : ''}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-1">
                                    <span class="font-bold text-sm ${t.type==='income'?'text-[#008B8B]':'text-[#4A4A4A]'}">
                                        ${t.type==='income'?'+':'-'} ${t.amount}
                                    </span>
                                    <button onclick="deleteTx(${t.id})" class="text-gray-300 p-1 active:text-red-400">${ICONS.trash}</button>
                                </div>
                            </div>
                            `
                        }).join('')
                    }
                </div>

                <!-- FAB -->
                <button onclick="openModal()" class="fixed bottom-8 right-6 w-14 h-14 bg-[#4A4A4A] text-white rounded-full shadow-xl shadow-[#4A4A4A]/30 flex items-center justify-center z-30 active:scale-90 transition-transform">
                    ${ICONS.plus}
                </button>
            `;
            
            renderModals();
        }

        function renderModals() {
            const container = document.getElementById('modal-container');
            if(state.modalOpen) {
                container.innerHTML = `
                <div class="fixed inset-0 bg-[#4A4A4A]/40 backdrop-blur-[2px] z-50 flex items-end justify-center fade-in" onclick="state.modalOpen=false;render()">
                    <div class="bg-white w-full max-w-md rounded-t-[2rem] p-6 shadow-2xl slide-up" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-[#4A4A4A]">记一笔</h3>
                            <button onclick="state.modalOpen=false;render()" class="p-2 bg-[#F5F5F5] rounded-full text-[#9FA0A0]">${ICONS.x}</button>
                        </div>
                        <div class="flex p-1 bg-[#F5F5F5] rounded-xl mb-6">
                            <button onclick="state.formType='expense';render()" class="flex-1 py-2.5 text-xs font-bold rounded-lg transition-all ${state.formType==='expense'?'bg-white shadow-sm text-[#4A4A4A]':'text-[#B0B0B0]'}">支出</button>
                            <button onclick="state.formType='income';render()" class="flex-1 py-2.5 text-xs font-bold rounded-lg transition-all ${state.formType==='income'?'bg-white shadow-sm text-[#4A4A4A]':'text-[#B0B0B0]'}">收入</button>
                        </div>
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-12 h-12 rounded-full bg-[#FFF9F5] flex items-center justify-center text-xl font-bold text-[#D3C0B6]">¥</div>
                            <input type="number" value="${state.formAmount}" oninput="state.formAmount=this.value;render()" placeholder="0.00" class="flex-1 py-2 bg-transparent text-3xl font-bold text-[#4A4A4A] focus:outline-none" autofocus>
                        </div>
                        <div class="mb-4">
                            <input type="date" value="${state.formDate}" onchange="state.formDate=this.value;render()" class="w-full px-4 py-2 bg-[#F9F9F9] rounded-xl text-sm text-[#5D5D5D] focus:outline-none">
                        </div>
                        <div class="grid grid-cols-4 gap-3 mb-6">
                            ${(state.formType==='income'?CATEGORIES.income:CATEGORIES.expense).map(c => `
                                <button onclick="state.formCategory='${c.id}';render()" class="flex flex-col items-center gap-2 p-2 rounded-xl transition-all ${state.formCategory===c.id?'bg-[#F0F0F0] ring-1 ring-[#D3D3D3]':''}">
                                    <div class="w-9 h-9 rounded-full flex items-center justify-center ${state.formCategory===c.id?'scale-110 bg-white shadow-sm':'bg-[#F5F5F5] text-[#D3D3D3]'}">
                                        <div class="scale-75">${ICONS[c.icon]}</div>
                                    </div>
                                    <span class="text-[10px] ${state.formCategory===c.id?'font-bold text-[#5D5D5D]':'text-[#BCBCBC]'}">${c.name}</span>
                                </button>
                            `).join('')}
                        </div>
                        <input value="${state.formNote}" oninput="state.formNote=this.value" placeholder="备注..." class="w-full px-4 py-3 bg-[#F9F9F9] rounded-xl text-sm focus:outline-none mb-4">
                        <button onclick="submitTx()" class="w-full py-3.5 bg-[#4A4A4A] text-white font-bold rounded-xl shadow-lg" ${!state.formAmount?'disabled style="opacity:0.5"':''}>完成</button>
                    </div>
                </div>`;
            } else if (state.settingsOpen) {
                container.innerHTML = `
                <div class="fixed inset-0 bg-black/20 backdrop-blur-[1px] z-50 flex items-center justify-center p-6 fade-in" onclick="state.settingsOpen=false;save();render()">
                    <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-xl slide-up" onclick="event.stopPropagation()">
                        <h3 class="text-lg font-bold text-[#4A4A4A] mb-2">每月预算</h3>
                        <input type="number" value="${state.budget}" oninput="state.budget=Number(this.value)" class="w-full p-3 bg-[#F5F5F5] rounded-xl text-xl font-bold text-[#4A4A4A] mb-4 focus:outline-none">
                        <p class="text-xs text-[#BCBCBC] mb-4">修改后会自动保存哦</p>
                        
                        <div class="border-t pt-4">
                            <h3 class="text-lg font-bold text-[#4A4A4A] mb-2">导入数据 (CSV/Excel)</h3>
                            <button onclick="triggerImport()" class="w-full py-3 bg-[#E0FFFF] text-[#008B8B] font-bold rounded-xl mb-2 text-sm">选择文件...</button>
                            <p class="text-[10px] text-[#BCBCBC]">自动去重 · 支持多次导入</p>
                        </div>
                    </div>
                </div>`;
            } else { container.innerHTML = ''; }
        }

        // --- 交互逻辑 ---
        function changeMonth(delta) { const d = new Date(state.currentDate); d.setMonth(d.getMonth() + delta); state.currentDate = d; render(); }
        function openModal() { state.modalOpen = true; state.formAmount=''; state.formCategory=''; state.formNote=''; render(); }
        function openSettings() { state.settingsOpen = true; render(); }
        function submitTx() {
            if(!state.formAmount) return;
            state.transactions.unshift({
                id: Date.now(), type: state.formType, amount: parseFloat(state.formAmount).toFixed(2),
                category: state.formCategory||'other', note: state.formNote, date: new Date(state.formDate).toISOString()
            });
            save(); state.modalOpen = false; render();
        }
        function deleteTx(id) { if(confirm('删掉这条？')) { state.transactions = state.transactions.filter(t=>t.id!==id); save(); render(); } }

        // --- 修复后的文件处理 (iOS兼容版 + 智能去重) ---
        // 1. 恢复：只接受 .json
        const restoreInput = document.createElement('input'); 
        restoreInput.type='file'; 
        restoreInput.accept='.json,application/json'; 
        restoreInput.style.display='none';
        restoreInput.onchange = e => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = ev => { try { state.transactions = JSON.parse(ev.target.result); save(); render(); alert('恢复成功！'); } catch(e){alert('文件不对');} };
            r.readAsText(f); e.target.value=null;
        };
        
        // 2. 导入：放开限制，允许选择所有文件，在JS里判断
        const importInput = document.createElement('input'); 
        importInput.type='file'; 
        importInput.accept = '*/*'; // 兼容iOS
        importInput.style.display='none';
        
        importInput.onchange = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                const text = evt.target.result;
                const lines = text.split(/\r\n|\n/);
                let count = 0;
                let skipCount = 0;
                
                lines.forEach(line => {
                    if(!line.trim()) return;
                    const parts = line.split(/,|，|\t/);
                    let amt = null, type = 'expense', cat = 'other', note = '', date = new Date().toISOString();
                    
                    // 日期解析
                    parts.forEach(p => { const d = parseChineseDate(p); if(d) date = d; });
                    
                    // 金额解析
                    parts.forEach(p => {
                        const clean = p.replace(/["¥\s]/g, '');
                        if(/^-?\d+(\.\d+)?$/.test(clean) && Math.abs(parseFloat(clean)) < 100000 && !parseChineseDate(p)) {
                            if(amt === null) {
                                amt = Math.abs(parseFloat(clean));
                                if(parseFloat(clean) < 0) type = 'expense';
                            }
                        }
                    });
                    
                    // 分类解析
                    const txt = line.toLowerCase();
                    let matched = false;
                    CATEGORIES.expense.forEach(c => { if(c.keywords.some(k=>txt.includes(k))) { cat = c.id; type='expense'; matched=true; } });
                    if(!matched) CATEGORIES.income.forEach(c => { if(c.keywords.some(k=>txt.includes(k))) { cat = c.id; type='income'; } });

                    if(amt !== null) {
                        const newTx = { id: Date.now()+Math.random(), type, amount: amt.toFixed(2), category: cat, note: txt.slice(0,10), date };
                        if(isDuplicate(newTx)) {
                            skipCount++;
                        } else {
                            state.transactions.push(newTx);
                            count++;
                        }
                    }
                });
                
                let msg = '';
                if(count > 0) msg += `成功导入 ${count} 条新记录！`;
                if(skipCount > 0) msg += `\n已自动跳过 ${skipCount} 条重复记录。`;
                
                if(msg) { alert(msg); save(); render(); }
                else { alert('没读出有效数据，或者数据全是重复的~'); }
            };
            reader.readAsText(file);
            e.target.value = null;
        };

        document.body.appendChild(restoreInput);
        document.body.appendChild(importInput);

        window.triggerBackup = () => {
            const blob = new Blob([JSON.stringify(state.transactions)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Mumu_Backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        };
        window.triggerRestore = () => restoreInput.click();
        window.triggerImport = () => importInput.click();

        init();
    </script>
</body>
</html>
